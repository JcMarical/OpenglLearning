# Phisically Based Rendering

# Throey

判断一种PBR光照模型是否是基于物理的，必须满足以下三个条件（不用担心，我们很快就会了解它们的）：

1. 基于微平面(Microfacet)的表面模型。
2. 能量守恒。
3. 应用基于物理的BRDF。

## Microfacet

假设一个**粗糙度(Roughness)**参数

我们可以基于一个平面的粗糙度来计算出众多微平面中，朝向方向沿着某个向量hℎ方向的比例。这个向量h便是位于光线向量和视线向之间的半程向量(Halfway Vector)。

![image-20230920211723461](D:\Program\OpenGL\LearnOpenGL\PBR.assets\image-20230920211723461.png)

微平面的朝向方向与半程向量的方向越是一致，镜面反射的效果就越是强烈越是锐利。通过使用一个介于0到1之间的粗糙度参数，我们就能概略地估算微平面的取向情况了：

![img](D:\Program\OpenGL\LearnOpenGL\PBR.assets\ndf.png)

## Energy conservation

出射光线的能量永远不能超过入射光线的能量（发光面除外）。随着粗糙度的上升，镜面反射区域会增加，但是镜面反射的亮度却会下降。

为了遵守能量守恒定律，我们需要对漫反射光和镜面反射光做出明确的区分。当一束光线碰撞到一个表面的时候，它就会分离成一个折射部分和一个反射部分。反射部分就是会直接反射开而不进入平面的那部分光线，也就是我们所说的镜面光照。而折射部分就是余下的会进入表面并被吸收的那部分光线，也就是我们所说的漫反射光照。

### 金属和非金属

对于金属(Metallic)表面，当讨论到反射与折射的时候还有一个细节需要注意。金属表面对光的反应与非金属（也被称为介电质(Dielectrics)）表面相比是不同的。它们遵从的反射与折射原理是相同的，但是**所有的**折射光都会被直接吸收而不会散开，只留下反射光或者说镜面反射光。亦即是说，金属表面只会显示镜面反射颜色，而不会显示出漫反射颜色。由于金属与电介质之间存在这样明显的区别，因此它们两者在PBR渲染管线中被区别处理



### 折射和反射	

我们得到了另一条关于能量守恒的经验结论：反射光与折射光它们二者之间是**互斥**的关系。

我们按照能量守恒的关系，首先计算镜面反射部分，它的值等于入射光线被反射的能量所占的百分比。然后折射光部分就可以直接由镜面反射部分计算得出：

```c++
float kS = calculateSpecularComponent(...); // 反射/镜面 部分
float kD = 1.0 - ks;                        // 折射/漫反射 部分
```

## 反射率方程

**[渲染方程](https://learnopengl.com/wiki-rendereuqation)(Render Equation)**是某些聪明绝顶的人所构想出来的一个精妙的方程式，是如今我们所拥有的用来模拟光的视觉效果最好的模型。

而基于物理的渲染所坚定遵循的是一种被称为反射率方程(The Reflectance Equation)的渲染方程的特化版本。

**辐射通量**：辐射通量Φ表示的是一个光源所输出的能量，以瓦特为单位。光是由多种不同波长的能量所集合而成的，而每种波长则与一种特定的（可见的）颜色相关。因此一个光源所放射出来的能量可以被视作这个光源包含的所有各种波长的一个函数。波长介于390nm到700nm（纳米）的光被认为是处于可见光光谱中，也就是说它们是人眼可见的波长。在下面你可以看到一幅图片，里面展示了日光中不同波长的光所具有的能量：

**立体角**：立体角用ω表示，它可以为我们描述投射到单位球体上的一个截面的大小或者面积。投射到这个单位球体上的截面的面积就被称为立体角(Solid Angle)，你可以把立体角想象成为一个带有体积的方向：

**辐射强度**：辐射强度(Radiant Intensity)表示的是在单位球面上，一个光源向每单位立体角所投送的辐射通量。举例来说，假设一个全向光源向所有方向均匀的辐射能量，辐射强度就能帮我们计算出它在一个单位面积（立体角）内的能量大小：

计算辐射强度的公式如下所示：
$$
I = \frac{d\phi}{dω}
$$
**辐射率**:这个方程表示的是，一个拥有辐射强度ΦΦ的光源在单位面积A�，单位立体角ω�上的辐射出的总能量：
$$
L = \frac{d^2Φ}{dAdω\cos\theta}
$$


![img](D:\Program\OpenGL\LearnOpenGL\PBR.assets\radiance.png)

其中cosθ就直接对应于光线的方向向量和平面法向量的点积：

```c++
float cosTheta = dot(lightDir, N);
```

当涉及到辐射率时，我们通常关心的是**所有**投射到点p�上的光线的总和，而这个和就称为辐射照度或者辐照度(Irradiance)。在理解了辐射率和辐照度的概念之后，让我们再回过头来看看反射率方程：
$$

L_o(p,ω_o)=∫_Ωfr(p,ω_i,ω_o)Li(p,ω_i)n⋅ω_idω_i
$$
